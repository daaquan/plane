# ==============================================
# Plane - Nginx Reverse Proxy Configuration
# https://plane.daaquan.com
# ==============================================
#
# Architecture:
#   Browser --> Cloudflare (SSL) --> tanuki (nginx HTTP:80) --> plane server (containers)
#
# Nginx runs on the "tanuki" server (see ~/.ssh/config).
# SSL termination is handled by Cloudflare (default certificate).
#
# Deployment:
#   scp /opt/plane/nginx-plane.conf tanuki:/tmp/plane.daaquan.com.conf
#   ssh tanuki "sudo cp /tmp/plane.daaquan.com.conf /etc/nginx/conf.d/plane.daaquan.com.conf"
#   ssh tanuki "sudo nginx -t && sudo systemctl reload nginx"
#
# Container host: 10.100.0.11 (plane server)
#

# --- Upstreams -----------------------------------------------------------

upstream plane-web {
    server 10.100.0.11:3000;
}

upstream plane-api {
    server 10.100.0.11:8080;
}

upstream plane-space {
    server 10.100.0.11:3002;
}

upstream plane-admin {
    server 10.100.0.11:3003;
}

upstream plane-live {
    server 10.100.0.11:3004;
}

# --- HTTP ----------------------------------------------------------------
# Cloudflare handles SSL termination; nginx listens on HTTP only.

server {
    listen 80;
    listen [::]:80;
    server_name plane.daaquan.com;

    # Request limits
    client_max_body_size 5m;

    # Common proxy headers
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    # Hardcoded to https: Cloudflare always terminates SSL, but $scheme
    # here is "http" which causes Django CSRF_COOKIE_SECURE mismatch.
    proxy_set_header X-Forwarded-Proto https;

    # --- API (/api/, /auth/, /static/) ---
    location /api/ {
        proxy_pass http://plane-api;
    }

    location /auth/ {
        proxy_pass http://plane-api;
    }

    location /static/ {
        proxy_pass http://plane-api;
    }

    # --- Spaces ---
    location = /spaces {
        return 301 /spaces/;
    }

    location /spaces/ {
        proxy_pass http://plane-space;
    }

    # --- Admin (God Mode) ---
    location = /god-mode {
        return 301 /god-mode/;
    }

    location /god-mode/ {
        proxy_pass http://plane-admin;
    }

    # --- Live (WebSocket) ---
    location /live/ {
        proxy_pass http://plane-live;
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # --- S3 uploads (RustFS at 10.100.0.10:9000) ---
    # IMPORTANT: Use "/plane" (no trailing slash) so nginx matches both
    #   /plane   (presigned POST URL for direct S3 upload)
    #   /plane/  (presigned GET URL for asset download)
    # A trailing-slash-only location "/plane/" will NOT match the POST
    # target, causing uploads to fall through to plane-web and fail.
    location /plane {
        proxy_pass http://10.100.0.10:9000;
    }

    # --- Web (default) ---
    location / {
        proxy_pass http://plane-web;
    }
}
